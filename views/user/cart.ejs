<%- include('navbar') -%>

<style>
    .swal2-popup {
      font-size: 1.2em !important;
      width: 400px !important;
    }
    .swal2-title {
      font-size: 1.5em !important;
    }
    .swal2-content {
      font-size: 1.2em !important;
    }
    .swal2-confirm, .swal2-cancel {
      font-size: 1.1em !important;
      padding: 10px 24px !important;
    }
  </style>

<main class="main__content_wrapper">
    <!-- Start breadcrumb section -->
    <section class="breadcrumb__section breadcrumb__bg">
        <div class="container">
            <div class="row row-cols-1">
                <div class="col">
                    <div class="breadcrumb__content text-center">
                        <h1 class="breadcrumb__content--title text-white mb-25">Shopping Cart</h1>
                        <ul class="breadcrumb__content--menu d-flex justify-content-center">
                            <li class="breadcrumb__content--menu__items"><a class="text-white" href="index.html">Home</a></li>
                            <li class="breadcrumb__content--menu__items"><span class="text-white">Shopping Cart</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- End breadcrumb section -->

    <!-- cart section start -->
    <section class="cart__section section--padding">
        <div class="container">
            <div class="cart__section--inner">
                <form action="#" method="post">
                    <h2 class="cart__title mb-4">Shopping Cart</h2>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="cart__table">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Image</th>
                                            <th>Product</th>
                                            <th>Size</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                            <th>Total</th>
                                            <th>Remove</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (cart && cart.item && cart.item.length > 0) { %>
                                            <% cart.item.forEach((item, index) => { %>
                                                <tr>
                                                    <td>
                                                        <img src="<%= item.productId.image[0] %>" alt="<%= item.productId.name %>" class="img-fluid" style="max-width: 80px;">
                                                    </td>
                                                    <td>
                                                        <h5><%= item.productId.name %></h5>
                                                        <% if (item.outOfStock) { %>
                                                            <span class="text-danger">Out of Stock</span>
                                                        <% } %>
                                                    </td>
                                                    <td><%= item.size %></td>
                                                    <td>₹<%= item.price.toFixed(2) %></td>
                                                    <td>
                                                        <div class="quantity__box">
                                                            <button type="button" onclick="updateQuantity('<%= cart._id %>', '<%= item.productId._id %>', '<%= item.size %>', '<%= item.price %>', '<%= index %>', -1)" class="btn btn-outline-secondary btn-sm">&minus;</button>
                                                            <input type="number" class="form-control form-control-sm d-inline-block w-50" value="<%= item.quantity %>" id="sst<%= index %>" readonly>
                                                            <button type="button" onclick="updateQuantity('<%= cart._id %>', '<%= item.productId._id %>', '<%= item.size %>', '<%= item.price %>', '<%= index %>', 1)" class="btn btn-outline-secondary btn-sm">&plus;</button>
                                                        </div>
                                                    </td>
                                                    <td><span id="total<%= index %>">₹ <%= (item.price * item.quantity).toFixed(2) %></span></td>
                                                    <td>
                                                        <a onclick="confirm('/delete/<%= item._id %>/<%= item.size %>')" class="delete-item">
                                                            <button type="button" class="btn btn-danger btn-sm">X</button>
                                                        </a>
                                                    </td>
                                                </tr>
                                            <% }) %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="7" class="text-center">Your cart is empty.</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <a href="/shop" class="continue__shipping--btn primary__btn border-radius-5 style="padding: 10px 20px;">Continue Shopping</a>
                                <div class="border p-3" style="min-width: 200px;">
                                    <h4 class="text-center">Cart Totals</h4>
                                    <div class="d-flex justify-content-between mt-3">
                                        <span>Total:</span>
                                        <strong id="total">₹ <%= cart.total.toFixed(2) %></strong>
                                    </div>
                                    <div class="mt-4">
                                        <a href="/checkout" class="continue__shipping--btn primary__btn border-radius-5 fixed-width-button">Proceed to Checkout</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>
    <!-- cart section end -->
</main>

<script>
    function confirm(itemId) {
        Swal.fire({
            title: "Are you sure?",
            text: "Are you sure you want to proceed?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Confirm",
            cancelButtonText: "Cancel",
            dangerMode: true,
            customClass: {
                popup: 'swal2-popup',
                title: 'swal2-title',
                content: 'swal2-content',
                confirmButton: 'swal2-confirm',
                cancelButton: 'swal2-cancel'
            }
        })
        .then((result) => {
            if (result.isConfirmed) {
                window.location.href = itemId;
            } else {
                console.log("User canceled");
            }
        });
    }

    async function updateQuantity(cartId, productId, size, price, index, count) {
        try {
            let quantityInput = document.getElementById(`sst${index}`);
            let currentQuantity = parseInt(quantityInput.value);
            const response = await fetch(`/updateCartQuantity/${productId}/${size}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cartId: cartId,
                    action: count,
                    newQuantity: count + currentQuantity,
                })
            });
            const data = await response.json();
            if (data.success) {
                quantityInput.value = data.newQuantity;
                document.getElementById(`total${index}`).innerText = `₹ ${price * data.newQuantity}`;
                document.getElementById('total').innerText = `₹ ${data.total}`;
            } else {
                console.error('Failed to update quantity:', data.error);
                quantityInput.value = currentQuantity;
                if (data.error === 'Quantity exceeds stock limits') {
                    Swal.fire({
                        text: 'Quantity exceeds stock limits',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        customClass: {
                            popup: 'swal2-popup',
                            title: 'swal2-title',
                            content: 'swal2-content',
                            confirmButton: 'swal2-confirm'
                        },
                        showCancelButton: false,
                        showCloseButton: true,
                        showLoaderOnConfirm: false,
                        timer: 3000
                    });
                } else {
                    Swal.fire({
                        text: 'Quantity Cannot be zero',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        customClass: {
                            popup: 'swal2-popup',
                            title: 'swal2-title',
                            content: 'swal2-content',
                            confirmButton: 'swal2-confirm'
                        },
                        showCancelButton: false,
                        showCloseButton: true,
                        showLoaderOnConfirm: false,
                        timer: 3000
                    });
                }
            }
        } catch (error) {
            console.error('Error parsing cart JSON:', error);
        }
    }
</script>

<%- include('footer') %>
